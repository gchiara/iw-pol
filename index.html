<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="twitter:card" content="summary" />
	<meta name="twitter:site" content="" />
	<meta property="og:url" content="" />
	<meta property="og:title" content="Integrity Watch Polska" />
	<meta property="og:description" content="" />
	<meta property="og:image" content="" />
	<title>Integrity Watch Polska</title>
	<link rel="shortcut icon" href="favicon.ico">
	<link href="css/bower.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="./css/dc.css" />
	<link rel="stylesheet" type="text/css" href="./css/style.css"/>
	<script src="./js/jquery.min.js"></script>
	<script src="./js/jquery.dataTables.min.js"></script>
	<script src="./js/underscore-min.js"></script>
	<script src="./js/crossfilter2.min.js"></script>
	<script src="./js/d3.js"></script>
	<script src="./js/dc.js"></script>
	<script src="./js/bootstrap.min.js"></script>
	<style>
		.graphs-second-row-toggle {
			cursor: pointer;
		}
		.graphs-second-row {
			display: none;
		}
	</style>
</head>

<body>
	<div id="loader-container">
		<div id="loader"></div>
	</div>
	<nav class="navbar navbar-default" role="navigation">
		<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<div class="navbar-brand" id="ti_logo_container">
							<!-- <a id="ti_logo" href="#">Jawny Lobbing</a> -->
							<!-- <a id="page_title" href="/">Integrity<br />Watch <strong>Polska</strong></a> -->
							<div class="project-title project-title1" href="/"><strong>Jawny<br />Lobbing</strong></div>
							<div class="project-title project-title2" href="/"><strong>Integrity<br />Watch Polska</strong></div>
					</div>
				</div>
			
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav">
						<li class="active" id="cm_tool_btn"><a href="" class="menu-link1"><strong>Lobbing w komisjach sejmowych</strong></a></li>
						<li id="cm_tool_btn"><a href="lobbyists.html" class="menu-link1"><strong>Działalność lobbystów zawodowych</strong></a></li>
						<li class="dropdown">
							<a aria-expanded="false" aria-haspopup="true" role="button" data-toggle="dropdown" class="dropdown-toggle menu-link2" href="#" style="width: 120px;">Inne wersje<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li><a href="http://www.integritywatch.eu">Unia Europejska</a></li>
								<li><a href="http://www.integritywatch.fr">Francja</a></li>
								<li><a href="">Zjednoczone Królestwo</a></li>
							</ul>
						</li>
					</ul>
					<ul class="nav navbar-nav navbar-right">
						<li><a href="about.html">O projekcie</a></li>
						<!-- <li><a href="contact.html">Contacts</a></li> -->
					</ul>
				</div>
		</div><!-- container -->
	</nav>
	<div class="about-container">
		Na tej stronie znajdziesz informacje, dotyczące osób i instytucji, uczestniczących w posiedzeniach komisji sejmowych obecnej kadencji (od 2015 r.). W posiedzeniach komisji biorą udział przedstawiciele wszystkich sektorów i branż, od publicznego po pozarządowy. Sprawdź, kto uczestniczy w posiedzeniach komisji sejmowych, używając interaktywnych wykresów poniżej.<br />
		Źródłem danych jest strona internetowa Sejmu.		
	</div>
	<div class="container_wrap cm_header" id="about_wrap_top">&nbsp;</div>

	<div class="container_wrap filter_cm" id="filter_wrap">
		<div class="container">
			<div class="row">
				<div class="col-md-4" id="filter_field_container">
					<p>Filtruj według:</p>
					<div class="input-group">
							<input type="text" id="search-input" class="form-control input-lg" placeholder="szukaj ...">
					</div>
				</div>
				<div class="col-md-7" id="filter_numbers">
					<div class="row">
						<div class="col-md-5" id="currently_selected_text"><p>Wybrany:</p></div>
						
						<div class="col-md-3 filter_number">
							<div id="mep_number" class="dc-data-count">
								<span id="abig_number" class="big_number filter-count"></span>z <strong class="total-count"></strong><br /> posiedzenie
							</div>
						</div>
						<div class="col-md-3 filter_number">
							<div id="org_number" class="org-count">
								<!-- <span class="big_number filter-count"></span>of <strong class="total-count"></strong><br /> people -->
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-1" id="resetall_container">
					<button class="btn resetall">Zresetuj<br />filtry</button>
				</div>
			</div>
		</div>
	</div>
	<div class="row" style="width:10px;">
		<div class="col-md-4"></div>
		<div class="col-md-4"></div>
		<div class="col-md-4"></div>
	</div>
	<div id="ec">
		<div class="container_wrap" id="main_charts_wrap">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<h2 class="table_title" style="width: 100%;margin-bottom:20px;">Kto lobbuje w parlamencie?</h2>
					</div>
					<div class="col-md-3">
						<!-- Pie -->
						<div class="chart_box">
							<h3>Kto lobbuje w parlamencie? Sektory</h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Sprawdź, jakie organizacje i przedsiębiorstwa prowadzą działalność w parlamencie.</p>
							</div>
							<div class="category-pie chart-full"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-3">
						<!-- TOP 10 A -->
						<div class="chart_box">
							<h3>Top 10 organizacji</h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Sprawdź, które z organizacji społecznych i branżowych najczęściej uczestniczą w posiedzeniach komisji sejmowych.</p>
							</div>
							<div class="top10-a chart-full"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-3">
						<!-- TOP 10 B -->
						<div class="chart_box">
							<h3>Top 10 przedsiębiorstw</h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Sprawdź, jakie przedsiębiorstwa prywatne, państwowe i spółdzielnie najczęściej uczestniczą w posiedzeniach komisji sejmowych.</p>
							</div>
							<div class="top10-b chart-full"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-3">
						<!-- TOP 10 C -->
						<div class="chart_box">
							<h3>Top 10 związków zawodowych</h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Sprawdź, jakie związki zawodowe najczęściej uczestniczą w posiedzeniach komisji sejmowych.</p>
							</div>
							<div class="top10-c chart-full"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-md-12 graphs-second-row-toggle">
						<h2 class="table_title" style="width: 100%;margin-bottom:20px;">Kto uczestniczy w posiedzeniach komisji sejmowych?</h2>
					</div>
				</div>
				<div class="row graphs-second-row">
					<div class="col-md-4">
						<!-- CATEGORIES -->
						<div class="chart_box">
							<h3>Kto uczestniczy w posiedzeniach komisji sejmowych? Sektory</h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Sprawdź, z jakich sektorów wywodzą się uczestnicy posiedzeń komisji sejmowych.</p>
							</div>
							<div class="types chart-full"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-4" style="margin-top:0px;">
						<!-- TOP COMMITTEES -->
						<div class="chart_box" id="group_container">
							<h3>Komisje, w których uczestniczy najwięcej osób z zewnątrz</h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Sprawdź, na posiedzenia których komisji sejmowych przychodzi najwięcej zewnętrznych uczestników spoza składu poselskiego.</p>
							</div>
							<div class="topcommittee chart-full"></div>
							<div class="label">Liczba uczestników</div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-4" style="margin-top:0px;">
						<!-- ENTITIES -->
						<div class="chart_box" id="categoria">
							<h3>Kto uczestniczy w posiedzeniach komisji sejmowych?<!--span class="info">info</span--></h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Sprawdź, jakie instytucje, organizacje i firmy najczęściej są obecne na posiedzeniach komisji sejmowych.</p>
							</div>
							<div class="topentities" style="width:100%;"></div>
							<div class="legend">
							</div>
							<br class="clear" />
						</div>
					</div>
				</div>

			</div>
		</div>	
	</div>

	<div class="container_wrap" id="list_container">
		<div class="container">
			<div class="row">
				<div class="content" id="list_content">
					<h2 class="table_title" style="width: 100%;">Lobbyści na posiedzeniach komisji sejmowych
						<div class="info_chart">
							<span class="info">info</span>
							<p class="desc">Sprawdź, jakie instytucje reprezentują uczestnicy posiedzeń komisji sejmowych.</p>
						</div>
					</h2>
					<!-- <div id="last_update">Last updated: <span id="updatedate"></span></div> -->
				</div>
				
				<div class="col-md-12 table-responsive">
					<table class="table table-hover dc-data-grid tablesorter-bootstrap">
						<thead>
							<tr class="header">
								<th class="header">Komisja</th>
								<th class="header">Kadencja</th>
								<th class="header">Posiedzenie</th>
								<th class="header">Sprawa</th> 
								<th class="header">Nazwa Podmiotu</th> 
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
	</div>

<script>
	'use strict';

	var attendances = [];
	var events = [];
	var people = [];
	var entities = [];
	var categories = [];
	var committees = [];

	var meetingspages;
	var evt=null;
	var nameEvent=null;
	var datatable;

	//Utility functions
	function capitalize(string) {
		return string.charAt(0).toUpperCase() + string.slice(1);
	}
	function addcommas(x){
		return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}

	//Additional date sorting for datatables
	var dmy = d3.time.format("%d/%m/%Y");
	jQuery.extend( jQuery.fn.dataTableExt.oSort, {
		"date-eu-pre": function ( date ) {
					return dmy.parse(date);
		},
		"date-eu-asc": function ( a, b ) {
			return ((a < b) ? -1 : ((a > b) ? 1 : 0));
		},
		"date-eu-desc": function ( a, b ) {
			return ((a < b) ? 1 : ((a > b) ? -1 : 0));
		}
	} );

	//Doc ready
	$( document ).ready(function() {
		$('#collapse_about a').click(function(ev) {
			ev.preventDefault();
			$('#collapse_about a').toggleClass('opened');
			$('#collapse_about a').toggleClass('closed');
			$('#about_wrap').slideToggle('slow', function () {
				$('#about_wrap_top').slideToggle('fast')
			})	
		})
		$('.info').click(function(ev) {
			ev.preventDefault();
			if($(this).hasClass('opened')){
				$(this).removeClass('opened');
				$(this).parents('.info_chart').find('p.desc').slideUp('fast')
			}else{
				closeAllInfos();
				$(this).addClass('opened');
				$(this).parents('.info_chart').find('p.desc').slideDown('fast')
			}
		});
		function closeAllInfos() {
			$('.info').removeClass('opened');
			$('p.desc').slideUp('fast');
		}
	});
	//End doc ready

	//Grid function (generates graphs and counts)
	function grid (selector,data) {
		
		var ndx = crossfilter(data),
				all = ndx.groupAll();

		var color = d3.scale.linear()
					.clamp(true)
					.domain([0,1, 70])
					.range(["white","#ffc7b6", "#f85631"])
					.interpolate(d3.interpolateHcl);

		evt = ndx.dimension(function(d) {
			return d.num;		
		})
		
		var eventgroup   = evt.group().reduce(
			function(p,d) {  
				p.nb +=1;
				if (!d.organisation)
				  return p;
				p.fte += d.fte;
				p.accredited += d.accredited;
				return p;
			},
			function(p,d) {  
				p.nb -=1;
				 if (!d.organisation)
				   return p;
				p.fte -= d.fte;
				p.accredited -= d.accredited;
				return p;
			},
			function(p,d) {  
				return {nb:0,fte:0,accredited:0}; 
			}
		);
		
		var count=dc.dataCount(".dc-data-count")
			.dimension(eventgroup)
			.group({value: function() {
				return eventgroup.all().filter(function(kv) { return kv.value.nb>0; }).length;
			}});

		count.on("renderlet.resetall", function(c) {
				var total=c.dimension().size();
				var filtered= c.group().value();
				var disabled= (total == filtered);

				$(".resetall").attr("disabled",disabled);

				if (filtered >=0) {
					var one2one=0;
					eventgroup.all().forEach(function(d) { if(d.value ==1) one2one ++;});
					var ratio=Math.round(100-one2one/filtered*100);
					$(".one2one").html( ratio + "% collective meetings");
				}
		  RefreshTable();
		});

		dc.dataCount(".dc-data-count2")
			.dimension(ndx)
			.group(all);

		nameEvent = ndx.dimension(function(d) {
			//console.log('test '+d.entityName.toString()+" "+d.categoriesNames.toString()+" "+d.participantsNames.toString()+" "+d.topics.toString());
			return d.entityName.toString()+" "+d.categoriesNames.toString()+" "+d.participantsNames.toString()+" "+d.topics.toString();
		});

		function rotateBarChartLabels(chart) {
			chart.svg().selectAll('.axis.x text')
				.style("text-anchor", "end" )
				.attr("transform", function(d) { return "rotate(-45, -4, 9) "; });
		}

		/* First row */

		//Category pie
		function drawCategoryPie () {

			var dim = ndx.dimension(function(d){ 
				var allowedCats = ["fundacje i stowarzyszenia, organizacje społeczne","organizacje branżowe i izby","przedsiębiorstwa i spółdzielnie","związki pracodawców","związki zawodowe"];
				var returnCats = [];
				d.categoriesNames.forEach(function(item) {
					if(allowedCats.indexOf(item) > -1){
						returnCats.push(item);
					}
				});
				return returnCats; 
			}, true);
            var group = dim.group();
			var hosttypecolor = {			
				"Other":"#bbbbbb"
			};
			var chart = dc.pieChart(".category-pie")
				.innerRadius(40).radius(100)
				.cy(120)
				.height(400)
				.dimension(dim)
				.cap(7)
				.group(group)
				.colorAccessor(function (d, i){console.log(i);return i;})
				//.colors(d3.scale.category20())
				//.colors(d3.scale.ordinal().range(['#0f4c79','#1f5982','#386b90','#517e9e','#6b91ac','#89a7bd']))
				// .colors(d3.scale.ordinal().range(['#205983','#306e9a','#4487b5','#599fd2','#71bdf3']))
				.colors(d3.scale.ordinal().range(['#003f5c', '#665191', '#d45087', '#ff7c43', '#ffa600', '#2f4b7c', '#a05195', '#f95d6a']))
				//.colors(d3.scale.linear().range(['red','green']))
				.label(function (d) {
					return "";
				})
				.externalLabels(-40);				
				//.colorCalculator(function(d, i) { return hosttypecolor[d.key]; });
				chart.legend(dc.legend().x(30).y(250).itemHeight(13).gap(5));
			
			//chart.ordering(function(d) { return rangeorder(d); });
		}

		//Top 10 organizacji
		//top 10 organisation from the "fundacje i stowarzyszenia, organi-zacje społeczne" and "organizacje branżowe i izby" categories.
		function drawTop10A() {
			var dim = ndx.dimension (function(d) {
				//Graph A
				if(d.categoriesNames.indexOf("fundacje i stowarzyszenia, organi-zacje społeczne") > -1 || d.categoriesNames.indexOf("organizacje branżowe i izby") > -1){
					return d.entityName;
				} else {
					return "";
				}
			});	
			var group = dim.group().reduceSum(function(d) { return 1; });
			var filteredGroup = (function(source_group) {
				return {
					all: function() {
						return source_group.top(10).filter(function(d) {
							return (d.key != "" && d.key != "Unknown" && d.key != "Not mentioned" && d.value != 0);
						});
					}
				};
			})(group);
			var graph = dc.rowChart(".top10-a")   
				.margins({top: 0, right: 3, bottom: 20, left: 3})
				.height(400)
				//.width(165)
				.gap(3)
				.x(d3.scale.ordinal())
				.elasticX(true)
				.colorCalculator(function(d, i) {
					return "#306e9a";
				})
				.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(filteredGroup);

			graph.xAxis().ticks(5).tickFormat(d3.format("d"));	
		};

		function drawTop10B() {
			var dim = ndx.dimension (function(d) {
				//Graph B
				if(d.categoriesNames.indexOf("przedsiębiorstwa i spółdzielnie") > -1 || d.categoriesNames.indexOf("spółki skarbu państwa i przed-siębiorstwa państwowe") > -1){
					return d.entityName;
				} else {
					return "";
				}
			});	
			
			var group = dim.group().reduceSum(function(d) { return 1; });
			var filteredGroup = (function(source_group) {
				return {
					all: function() {
						return source_group.top(10).filter(function(d) {
							return (d.key != "" && d.key != "Unknown" && d.key != "Not mentioned" && d.value != 0);
						});
					}
				};
			})(group);
			var graph = dc.rowChart(".top10-b")   
				.margins({top: 0, right: 3, bottom: 20, left: 3})
				.height(400)
				//.width(165)
				.gap(3)
				.x(d3.scale.ordinal())
				.elasticX(true)
				.colorCalculator(function(d, i) {
					return "#4487b5";
				})
				.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(filteredGroup);

			graph.xAxis().ticks(5).tickFormat(d3.format("d"));	
		};

		function drawTop10C() {
			var dim = ndx.dimension (function(d) {
				//Graph C
				if(d.categoriesNames.indexOf("związki zawodowe") > -1){
					return d.entityName;
				} else {
					return "";
				}
			});	
			
			var group = dim.group().reduceSum(function(d) { return 1; });
			var filteredGroup = (function(source_group) {
				return {
					all: function() {
						return source_group.top(10).filter(function(d) {
							return (d.key != "" && d.key != "Unknown" && d.key != "Not mentioned" && d.value != 0);
						});
					}
				};
			})(group);
			var graph = dc.rowChart(".top10-c")   
				.margins({top: 0, right: 3, bottom: 20, left: 3})
				.height(400)
				//.width(165)
				.gap(3)
				.x(d3.scale.ordinal())
				.elasticX(true)
				.colorCalculator(function(d, i) {
					return "#71bdf3";
				})
				.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(filteredGroup);

			graph.xAxis().ticks(5).tickFormat(d3.format("d"));	
		};

		//Host Type Chart
		function drawHostType () {

			//var dim = ndx.dimension(function(d){ return d.categoriesNames; }, true);
			var dim = ndx.dimension(function(d){ 
				var notAllowedCats = ["Kancelaria Sejmu","pracownicy Sejmu i Senatu","władza centralna (rząd, prezydent)"];
				var returnCats = [];
				d.categoriesNames.forEach(function(item) {
					if(notAllowedCats.indexOf(item) == -1){
						returnCats.push(item);
					}
				});
				return returnCats; 
				//return d.categoriesNames; 
			}, true);

            var group = dim.group();
			var hosttypecolor = {			
				"Other":"#bbbbbb"
			};
			var chart = dc.pieChart(".types")
				.innerRadius(80).radius(140)
				.cy(150)
				.height(550)
				.dimension(dim)
				.cap(7)
				.group(group)
				.colorAccessor(function (d, i){console.log(i);return i;})
				// .colors(d3.scale.ordinal().range(['#205983','#28638e','#306e9a','#3b79a7','#4487b5','#4f94c3','#599fd2','#64ade0','#71bdf3']))
				.colors(d3.scale.ordinal().range(['#003f5c', '#2f4b7c', '#665191', '#a05195', '#d45087', '#f95d6a', '#ff7c43', '#ffa600']))
				//.colors(d3.scale.category20())
				.label(function (d) {
					return "";
				})
				.externalLabels(-40);				
				//.colorCalculator(function(d, i) { return hosttypecolor[d.key]; });
				chart.legend(dc.legend().x(30).y(330).itemHeight(13).gap(5));
			
			//chart.ordering(function(d) { return rangeorder(d); });
		}
		
		//Top entities
		function drawEntities() {
			var dim = ndx.dimension(function(d){ 
				var notAllowedCats = ["Kancelaria Sejmu","pracownicy Sejmu i Senatu","władza centralna (rząd, prezydent)"];
				var allowed = true;
				var result = [];
				d.categoriesNames.forEach(function(item) {
					if(notAllowedCats.indexOf(item) > -1){
						allowed = false;
					}
				});
				if(allowed){
					result.push(d.entityName);
				}
				return result;
			}, true);

            var group = dim.group();

			var filteredGroup = (function(source_group) {
				return {
					all: function() {
						return source_group.top(20).filter(function(d) {
							return (d.key != "Not mentioned" && d.value != 0);
						});
					}
				};
			})(group);
			var graph = dc.rowChart(".topentities")   
				.margins({top: 0, right: 3, bottom: 20, left: 3})
				.height(550)
				//.width(165)
				.gap(1)
				.x(d3.scale.ordinal())
				.elasticX(true)
				.colorCalculator(function(d, i) {
					return "#2371aa";
				})
				.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(filteredGroup);
				
			graph.xAxis().ticks(5).tickFormat(d3.format("d"));
			//chart.ordering(function(d) { return rangeorder(d); });
		}

		//Top committees
		function drawTopCommittee () {
			
			
			var dim = ndx.dimension(function(d){ 
				var notAllowedCats = ["Kancelaria Sejmu","pracownicy Sejmu i Senatu","władza centralna (rząd, prezydent)"];
				var allowed = true;
				var result = [];
				
				d.categoriesNames.forEach(function(item) {
					if(notAllowedCats.indexOf(item) > -1){
						allowed = false;
					}
				});
				
				if(allowed){
					if(d.committeeInfo.name){
						result.push(d.committeeInfo.name);
					} else {
						result.push("N/A");
					}
				}
				return result;
			}, true);
			
			
			var group = dim.group().reduceSum(function(d) { return 1; });
			var filteredGroup = (function(source_group) {
				return {
					all: function() {
						return source_group.top(110).filter(function(d) {
							return (d.key != "" && d.key != "Unknown" && d.key != "Not mentioned" && d.value != 0);
						});
					}
				};
			})(group);
			var graph = dc.rowChart(".topcommittee")   
				.margins({top: 0, right: 3, bottom: 20, left: 3})
				.height(550)
				//.width(165)
				.gap(3)
				.x(d3.scale.ordinal())
				.elasticX(true)
				.colorCalculator(function(d, i) {
					return "#2371aa";
				})
				.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(filteredGroup);

			graph.xAxis().ticks(5).tickFormat(d3.format("d"));	
		};

		//Datatables table
		function drawTable () {
			var count=0;

			datatable = $(".table").dataTable({
				"columnDefs": [ 
				  {
				  "searchable": false,
				  "orderable": true,
				  "targets": 0,
				  "defaultContent":"N/A",
				  "className":"capitalize",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 //return d.meeting_id; 
					 if(d.committeeInfo.name){
						return d.committeeInfo.name;
					 }
					 return d.committeeId; 
					},
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 1,
				  "defaultContent":"N/A",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 if(d.committeeInfo.term){
						return d.committeeInfo.term;
					 }
					},
				  },{
				  "defaultContent":"N/A",
				  "searchable": false,
				  "orderable": true,
				  "targets": 2,
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 //return d.person; 
					 return d.code;
					}
				  },{
				  "defaultContent":"N/A",
				  "searchable": false,
				  "orderable": true,
				  "type":"date-eu",
				  "targets": 3,
				  "data": function(d) {
					 if (!d) return "";
					 return d.topics;
					},
				  },
				   {
				  "defaultContent":"N/A",
				  "searchable": false,
				  "orderable": true,
				  "targets": 4,
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.entityName; 
					}
				  }
				],
				"iDisplayLength" : 100,
				"bPaginate": true,
				"bLengthChange": false,
				"bFilter": false,
				"order": [[ 1, "asc" ],[2,"asc"]],
				"bSort": true,
				"bInfo": false,
				"bAutoWidth": false,
				"bDeferRender": true,
				"aaData": nameEvent.top(Infinity),
				"bDestroy": true,
			});
		
			function countmeetings(who){
				var countedmeetings = _.filter(events, function(event, index) {
				  return event.nombrePasivoFull == who || event.nombreActivoFull == who;
				});
				return countedmeetings.length;
			}
				
			function format (d) {				
				if (!d) return "no data";

				var s  = "<div class='l_data_container row'>";
				
				s += "<div class='col-md-12 l_data_container_host'>";
				s += "<div class='l_name' style='text-align:center;margin-bottom:30px;'><label><strong>SPRAWA</strong></label><br />"+d.topics+"</div>";
				s += "<div class='data_container_title' style='text-align:center;'></div>";
				
				s += "<div class='l_name'><label>Kadencja:</label> "+d.committeeInfo.term+"</div>";
				s += "<div class='l_name'><label>Komisja:</label> "+d.committeeInfo.name+"</div>";
				s += "<div class='l_name'><label>Posiedzenie:</label> "+d.code+"</div>";
				s += "<div class='hr'></div>";
				s += "<div class='l_name'><label>Zewnętrzni uczestnicy:</label> "+d.participantsNames.join(', ')+"</div>";
				/* s += "<div class='l_name'><label>Funkcja/ stanowisko:</label> "+d.affiliation+"</div>"; */
				s += "<div class='l_name'><label>Nazwa podmiotu:</label> "+d.entityName+"</div>";
				s += "<div class='l_name'><label>Kategoria:</label> "+d.categoriesNames.join(', ')+"</div>";
				
				
				s += "</div>";
				s += "</div>";
				return s;
			}	
			//Datatables click function
			datatable.on('click', 'button', function () {
				var tr = $(this).closest('tr');
				var type=$(this).data("type");
				var pre=$(this).parent().parent().next("pre");
				var row = datatable.DataTable().row( tr.prev()[0] );
				var d=row.data();
			 
				if (type == "event") {
					var sevents =[];
					_.each(events,function (e){
					if (e.guestid == d.id)
					  sevents.push(e);
					});
					pre.html(JSON.stringify(sevents,null,2));
					return;
				}

				var r = (tr.data("representative"));
				if (!r) {
				  url="http://api.lobbyfacts.eu/api/1/representative/"+d.id+"?callback=?";
				  $.getJSON( url, function( data ) {
					tr.data("representative",data);
					display (data);
				  });
				  return;
				}
				display(r,type);

				function display (data) {
				  switch (type) {
					case "financial_data":
					 pre.html(JSON.stringify(data["financial_data"],null,2));
					  break;
					case "accreditation":
					 pre.html(JSON.stringify(data["accreditations"],null,2));
					  break;
					default:
					  pre.html(JSON.stringify(data,null,2));
				  }
				}
				
			});
		
			datatable.DataTable().on('click', 'tr[role="row"]', function () {
				var tr = $(this);
				var row = datatable.DataTable().row( tr );
				if ( row.child.isShown() ) {
					// This row is already open - close it
					row.child.hide();
					tr.removeClass('shown');
				}
				else {
					// Open this row
					row.child( format(row.data()) ).show();
					tr.addClass('shown');
					var height1 = $('.l_data_container_host').height();
					var height2 = $('.l_data_container_guest').height();
					if(height1 > height2){
						$('.l_data_container_guest').height(height1);
					} else {
						$('.l_data_container_host').height(height2);
					}
				}
			});
			
			datatable.DataTable().on( 'order.dt search.dt page.dt draw.dt', function () {
				var thispage = $('.paginate_button.current').html();			
				var rowi = 0;
				/*
			  datatable.DataTable().column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
				if(rowi >= 100){
					rowi = 0;
				}
				rowi ++;
				if(thispage > 1){
					cell.innerHTML = (rowi) + (100*(thispage-1));
				} else {
					cell.innerHTML = (rowi);
				}
			  });
			  */
			});
		}
		//End datatable table function

	   function RefreshTable() {
			dc.events.trigger(function () {
				var alldata = evt.top(Infinity);
				datatable.fnClearTable();
				datatable.fnAddData(alldata);
				datatable.fnDraw();
			});
		}

		//Draw graphs
		drawCategoryPie();
		drawTop10A();
		drawTop10B();
		drawTop10C();
		drawTable();
		drawHostType();
		drawTopCommittee();
		drawEntities();
		dc.renderAll();  
	}
	//End grid function

	$(function() {

		//Load datasets
		d3.json("data/normalized_attendances.json", function (dataset) {
			attendances = dataset.data.attendances;
			events = dataset.data.events;
			people = dataset.data.people;
			entities = dataset.data.entities;
			categories = dataset.data.categories;
			committees = dataset.data.committees;

			//renderLoaded();
			//var dateFormat = d3.time.format("%d/%m/%Y");
			var dateFormat = d3.time.format("%Y-%m-%d");
			var now = Date.now();
			var a;
			
			//Loop through dataset and fix/adjust data
			var thisid = 0;
			
			_.each (attendances, function (d) {
				d.entityName = "";
				d.categoriesNames = [];

				//Find event
				var thisevt = _.find(events,function (m) { return m.id == d.meetingId });
				if(thisevt){
					d.date = thisevt.date;
					d.code = thisevt.code;
					d.topics = thisevt.topics;
					d.committeeId = thisevt.committeeId;
					d.transcriptURL = thisevt.transcriptURL;
				}
				//Find committee name
				d.committeeInfo;
				var thiscommittee = _.find(committees,function (m) { return m.id == d.committeeId });
				if(thiscommittee){
					d.committeeInfo = thiscommittee;
				}
				//Get entity name
				var thisentity = _.find(entities,function (m) { return m.id == d.entityId });
				if(thisentity){
					d.entityName = thisentity.name;
					d.categories = thisentity.categoryIds;
				}
				//Get categories names
				_.each (d.categories, function (p) {
					var thiscat = _.find(categories,function (m) { return m.id == p });
					if(thiscat){
						d.categoriesNames.push(thiscat.name);
					}
				});
				//Get participants names
				d.participantsNames = [];
				_.each (d.entityParticipants, function (p) {
					var thispar = _.find(people,function (m) { return m.personId == p.personId });
					if(thispar){
						p.name = thispar.name;
						d.participantsNames.push(thispar.name);
					}
				});
				
				//Committee name Fix
				d.committee_full = "";
				if(d.committee == "OSZ"){
					d.committee_full = "Ochrony Środowiska, Zasobów Naturalnych i Leśnictwa";
				}
				//Type fix
				if(d.type == "Instytucja publiczna (np.. NIK)"){
					d.type = "Instytucja publiczna";
				}
				
				d.num = thisid;
				thisid ++;

				//console.log(d.entityName);

			});
			//End loop through dataset
			$('#loader-container').hide();
			//Call grid function to create and display charts
			grid ("#ec",attendances);
		});
		
		/*
		//Load datasets
		d3.json("data/normalized.json", function (dataset) {
			events = dataset.data.events;
			people = dataset.data.people;
			entities = dataset.data.entities;
			categories = dataset.data.categories;
			committees = dataset.data.committees;

			//renderLoaded();
			//var dateFormat = d3.time.format("%d/%m/%Y");
			var dateFormat = d3.time.format("%Y-%m-%d");
			var now = Date.now();
			var a;
			
			//Loop through dataset and fix/adjust data
			var thisid = 0;
			
			_.each (events, function (d) {
				
				d.type = "";

				d.entities = [];
				d.entitiesNames = [];
				d.categories = [];
				d.categoriesNames = [];

				//Find committee name
				//committees
				//"id":1,"code":"ASW","name":"Administracji i Spraw Wewnętrznych","term":"8"
				d.committeeInfo;
				var thiscommittee = _.find(committees,function (m) { return m.id == d.committeeId });
				if(thiscommittee){
					//d.committeeName = thiscommittee.name;
					//d.committeeCode = thiscommittee.code;
					d.committeeInfo = thiscommittee;
				}

				//Loop through participants, for each find person in people list and find related entities
				_.each (d.participants, function (p) {
					var thisperson = _.find(people,function (m) { return m.personId == p.personId });
					p.name = thisperson.name;
					d.entities = d.entities.concat(thisperson.entityIds);
				});
				d.entities = _.uniq(d.entities);
				//Loop through unique entities to find names and categories
				_.each (d.entities, function (p) {
					var thisentity = _.find(entities,function (m) { return m.id == p });
					if(thisentity){
						d.entitiesNames.push(thisentity.name);
						d.categories.push(thisentity.categoryIds);
					}
				});
				_.each (d.categories, function (p) {
					var thiscat = _.find(categories,function (m) { return m.id == p });
					if(thiscat){
						d.categoriesNames.push(thiscat.name);
					}
				});
				//console.log(d.entitiesNames);
				//console.log(d.categoriesNames);

				d.committee_full = "";
				if(d.committee == "OSZ"){
					d.committee_full = "Ochrony Środowiska, Zasobów Naturalnych i Leśnictwa";
				}
				
				//Type fix
				if(d.type == "Instytucja publiczna (np.. NIK)"){
					d.type = "Instytucja publiczna";
				}
				
				d.num = thisid;
				thisid ++;
			});
			//End loop through dataset
			$('#loader-container').hide();
			//Call grid function to create and display charts
			grid ("#ec",events);
		}); 
		*/
		
		//Toggle second row of graphs
		$('.graphs-second-row-toggle').click(function() {
			$('.graphs-second-row').toggle();
			dc.filterAll();
			dc.renderAll();
		});

		//Search field functionality
		$("#search-input").keyup (function () {
			var s = $(this ).val().toLowerCase();
			nameEvent.filter(function (d) { 
				return d.toLowerCase().indexOf (s) !== -1;} );
			$(".resetall").attr("disabled",false);
			throttle();
			var throttleTimer;
			function throttle() {
				window.clearTimeout(throttleTimer);
				throttleTimer = window.setTimeout(function() {
					console.log ("redraw");
						dc.redrawAll();
				}, 250);
			}
		});
		
		//Change selected term
		$( "#termselect" ).change(function () {
			var s = "termoffice:"+$( "select option:selected" ).text()+" ";
			nameEvent.filter(function (d) { 
				return d.indexOf (s) !== -1;} );
			$(".resetall").attr("disabled",false);
			throttle();
			var throttleTimer;
			function throttle() {
				window.clearTimeout(throttleTimer);
				throttleTimer = window.setTimeout(function() {
					console.log ("redraw");
						dc.redrawAll();
				}, 250);
			}
		  });
		 
		//Reset button
		$(".resetall").click(function() {
			nameEvent.filter(null);
			dc.filterAll();
			dc.renderAll();
			$("#search-input").val("");
			$(".resetall").attr("disabled",true);
			$( "#termselect" ).val("");
		}); 

		//On window resize redraw for responsive charts
		$(window).on('resize', function(){
			dc.renderAll();
		});

	});      

</script>
</body>
</html>
