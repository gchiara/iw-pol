<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="twitter:card" content="summary" />
	<meta name="twitter:site" content="" />
	<meta property="og:url" content="" />
	<meta property="og:title" content="Profesjonalni lobbyści" />
	<meta property="og:description" content="" />
	<meta property="og:image" content="" />
	<title>Profesjonalni lobbyści</title>
	<link rel="shortcut icon" href="favicon.ico">
	<link href="css/bower.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./css/dc.css" />
	<link rel="stylesheet" type="text/css" href="./css/style.css"/>
	<script src="./js/jquery.min.js"></script>
	<script src="./js/jquery.dataTables.min.js"></script>
	<script src="./js/underscore-min.js"></script>
    <script src="./js/crossfilter2.min.js"></script>
	<script src="./js/d3.js"></script>
	<script src="./js/dc.js"></script>
    <script src="./js/bootstrap.min.js"></script>  
</head>

<body class="lobbyists-tab">
	<div id="loader-container">
		<div id="loader"></div>
	</div>
	<nav class="navbar navbar-default" role="navigation">
		<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<div class="navbar-brand" id="ti_logo_container">
						<div class="project-title project-title1" href="/"><strong>Jawny<br />Lobbing</strong></div>
						<div class="project-title project-title2" href="/"><strong>Integrity<br />Watch Polska</strong></div>
					</div>
				</div>
			
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav">
                        <li id="cm_tool_btn"><a href="index.html" class="menu-link1"><strong>Lobbing w komisjach sejmowych</strong></a></li>
						<li class="active" id="cm_tool_btn"><a href="lobbyists.html" class="menu-link1"><strong>Działalność lobbystów zawodowych</strong></a></li>
						<li class="dropdown">
							<a aria-expanded="false" aria-haspopup="true" role="button" data-toggle="dropdown" class="dropdown-toggle menu-link2" href="#" style="width: 120px;">Inne wersje<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li><a href="http://www.integritywatch.eu">Unia Europejska</a></li>
								<li><a href="http://www.integritywatch.fr">Francja</a></li>
								<li><a href="">Zjednoczone Królestwo</a></li>
							</ul>
						</li>
					</ul>
					<ul class="nav navbar-nav navbar-right">
						<li><a href="about.html">O projekcie</a></li>
						<!-- <li><a href="contact.html">Contacts</a></li> -->
					</ul>
				</div>
		</div><!-- container -->
	</nav>
	<div class="about-container about-container-lobbyists">
		Na tej stronie znajdziesz najważniejsze informacje, dotyczące działalności lobbystów zawodowych w Polsce, czyli osób i firm, które zawodowo wykonują usługi lobbingowe na zle-cenie innych instytucji i przedsiębiorstw. Sprawdź, kim są lobbyści zawodowi i co ich interesuje, używając interaktywnych wykresów poniżej.<br />
		Źródłem danych są Ministerstwo Spraw Wewnętrznych, Sejm i Rejestr Przejrzystości UE.
	</div>
	<div class="container_wrap cm_header" id="about_wrap_top">&nbsp;</div>

	<div class="container_wrap filter_cm" id="filter_wrap">
		<div class="container">
			<div class="row">
				<div class="col-md-4" id="filter_field_container">
					<p>Filtruj według:</p>
					<div class="input-group">
							<input type="text" id="search-input" class="form-control input-lg" placeholder="szukaj ...">
					</div>
				</div>
				<div class="col-md-7" id="filter_numbers">
					<div class="row">
						<div class="col-md-5" id="currently_selected_text"><p>Wybrany:</p></div>
						
						<div class="col-md-3 filter_number">
							<div id="mep_number" class="dc-data-count">
								<span id="abig_number" class="big_number filter-count"></span>z <strong class="total-count"></strong><br /> posiedzenie
							</div>
						</div>
						<div class="col-md-3 filter_number">
							<div id="org_number" class="org-count">
								<!-- <span class="big_number filter-count"></span>of <strong class="total-count"></strong><br /> people -->
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-1" id="resetall_container">
					<button class="btn resetall">Zresetuj<br />filtry</button>
				</div>
			</div>
		</div>
	</div>
	<div class="row" style="width:10px;">
		<div class="col-md-4"></div>
		<div class="col-md-4"></div>
		<div class="col-md-4"></div>
	</div>
	<div id="ec">
		<div class="container_wrap" id="main_charts_wrap">
			<div class="container">
				<div class="row">
					<div class="col-md-4">
						<!-- MINISTRIES REGISTRATIONS ROWCHART -->
						<div class="chart_box" id="categoria">
							<h3>Działalność w ministerstwach<!--span class="info">info</span--></h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Sprawdź, z jakimi ministerstwami współpracowali lobbyści zawodowi.</p>
							</div>
							<div class="ministriesRegistrations"></div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-4">
						<!-- REGISTRATION DATE -->
						<div class="chart_box" id="categoria">
							<h3>Rejestr lobbystów zawodowych MSWiA<!--span class="info">info</span--></h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Sprawdź, ilu lobbystów zawodowych zarejestrowało się w MSWiA od 2006 r.</p>
							</div>
							<div class="registeryear"></div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-4">
						<!-- Types -->
						<div class="chart_box" id="group_container">
							<h3>Obszary aktywności lobbystów zawodowych</h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Sprawdź, w jakich obszarach prac rządu i parlamentu lobbyści zawodowi są najbardziej aktywni.</p>
							</div>
							<div class="types chart-full"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-6">
						<!-- WORDCLOUD -->
						<div class="chart_box" id="categoria">
							<h3>Tematy zainteresowań lobbystów<!--span class="info">info</span--></h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Kliknij w wybrane słowo i sprawdź, który lobbysta użył go w opisie przedmiotu swoich zainteres-owań.</p>
							</div>
							<div class="wordcloud"></div>
							<div class="legend">
							</div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-3">
						<!-- EU REGISTER AND PARLIAMENT ACTIVITY BARCHART -->
						<div class="chart_box">
							<h3>Lobbyści zawodowi w rządzie, parlamencie i Unii Europejskiej</h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Sprawdź, ilu lobbystów zawodowych jest aktywnych na terenie ministerstw, Sejmu i Senatu oraz w instytucjach Unii Europejskiej.</p>
							</div>
							<!-- <div class="types piechart"></div> -->
							<div class="euRegisterParliament"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-3">
						<!-- Types -->
						<div class="chart_box" id="group_container">
							<h3>Top lobbyists by number of subjects</h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc"></p>
							</div>
							<div class="top10subjects chart-full"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
				</div>

			</div>
		</div>	
	</div>

	<div class="container_wrap" id="list_container">
		<div class="container">
			<div class="row">
				<div class="content" id="list_content">
					<h2 class="table_title" style="width: 100%;">Lobbyści zawodowi
						<div class="info_chart">
							<span class="info">info</span>
							<p class="desc">Sprawdź więcej informacji na temat lobbystów zawodowych i działalności w Sejmie, rządzie i Unii Europejskiej.</p>
						</div>
					</h2>
					<!-- <div id="last_update">Last updated: <span id="updatedate"></span></div> -->
				</div>
				
				<div class="col-md-12 table-responsive">
					<table class="table table-hover dc-data-grid tablesorter-bootstrap">
						<thead>
							<tr class="header">
								<th class="header">Numer re-jestrze</th>
								<th class="header">Data rejestracji</th>
								<th class="header">Nazwa lobbysty zawodowego</th>
								<th class="header">Rejestr UE (T/N)</th>
								<th class="header">Przedmiot lobbingu w EU rejestr</th> 
                                <th class="header">Działalność w minister-stwach</th> 
                                <th class="header">Działalność w Sejmie i Senacie</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
	</div>

<script>
	'use strict';

	var events=[];
	var meetingspages;
	var evt=null;
	var nameEvent=null;
	var datatable;

	//Utility functions
	function capitalize(string) {
		return string.charAt(0).toUpperCase() + string.slice(1);
	}
	function addcommas(x){
		return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}

	//Additional date sorting for datatables
	var dmy = d3.time.format("%d/%m/%Y");
	jQuery.extend( jQuery.fn.dataTableExt.oSort, {
		"date-eu-pre": function ( date ) {
					return dmy.parse(date);
		},
		"date-eu-asc": function ( a, b ) {
			return ((a < b) ? -1 : ((a > b) ? 1 : 0));
		},
		"date-eu-desc": function ( a, b ) {
			return ((a < b) ? 1 : ((a > b) ? -1 : 0));
		}
	} );

	//Doc ready
	$( document ).ready(function() {
		$('#collapse_about a').click(function(ev) {
			ev.preventDefault();
			$('#collapse_about a').toggleClass('opened');
			$('#collapse_about a').toggleClass('closed');
			$('#about_wrap').slideToggle('slow', function () {
				$('#about_wrap_top').slideToggle('fast')
			})	
		})
		$('.info').click(function(ev) {
			ev.preventDefault();
			if($(this).hasClass('opened')){
				$(this).removeClass('opened');
				$(this).parents('.info_chart').find('p.desc').slideUp('fast')
			}else{
				closeAllInfos();
				$(this).addClass('opened');
				$(this).parents('.info_chart').find('p.desc').slideDown('fast')
			}
		});
		function closeAllInfos() {
			$('.info').removeClass('opened');
			$('p.desc').slideUp('fast');
		}
	});
	//End doc ready

	//Grid function (generates graphs and counts)
	function grid (selector,data) {
		
		var ndx = crossfilter(data),
				all = ndx.groupAll();

		var color = d3.scale.linear()
					.clamp(true)
					.domain([0,1, 70])
					.range(["white","#ffc7b6", "#f85631"])
					.interpolate(d3.interpolateHcl);

		evt = ndx.dimension(function(d) {
			return d.num;		
		})
		
		var eventgroup   = evt.group().reduce(
			function(p,d) {  
				p.nb +=1;
				if (!d.organisation)
				  return p;
				p.fte += d.fte;
				p.accredited += d.accredited;
				return p;
			},
			function(p,d) {  
				p.nb -=1;
				 if (!d.organisation)
				   return p;
				p.fte -= d.fte;
				p.accredited -= d.accredited;
				return p;
			},
			function(p,d) {  
				return {nb:0,fte:0,accredited:0}; 
			}
		);
		
		var count=dc.dataCount(".dc-data-count")
			.dimension(eventgroup)
			.group({value: function() {
				return eventgroup.all().filter(function(kv) { return kv.value.nb>0; }).length;
			}});

		count.on("renderlet.resetall", function(c) {
				var total=c.dimension().size();
				var filtered= c.group().value();
				var disabled= (total == filtered);

				$(".resetall").attr("disabled",disabled);

				if (filtered >=0) {
					var one2one=0;
					eventgroup.all().forEach(function(d) { if(d.value ==1) one2one ++;});
					var ratio=Math.round(100-one2one/filtered*100);
					$(".one2one").html( ratio + "% collective meetings");
				}
		  RefreshTable();
		});

		dc.dataCount(".dc-data-count2")
			.dimension(ndx)
			.group(all);

		nameEvent = ndx.dimension(function(d) {
			//return d.entityName.toLowerCase()+" "+d.category.toLowerCase()+" "+d.ministries.toLowerCase()+" "+d.representatives.toLowerCase()+ " "+d.clients.toLowerCase()+ " " + d.subject.toLowerCase();
			return d.entityName.toLowerCase()+" "+d.category.toLowerCase()+" " + d.subject.toString().toLowerCase();
		});

		function rotateBarChartLabels(chart) {
			chart.svg().selectAll('.axis.x text')
				.style("text-anchor", "end" )
				.attr("transform", function(d) { return "rotate(-45, -4, 9) "; });
		}

		//Type Chart
		function drawHostType () {
            var dim = ndx.dimension(function(d){ return d.type; }, true);
            var group = dim.group();
			var hosttypecolor = {			
				"Other":"#bbbbbb"
			};
			var graph = dc.rowChart(".types")   
				.margins({top: 0, right: 3, bottom: 20, left: 3})
				.height(400)
				.gap(3)
				.x(d3.scale.ordinal())
				.elasticX(true)
				.colorCalculator(function(d, i) {
					return "#039aab";
				})
				.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(group);

			graph.xAxis().ticks(5).tickFormat(d3.format("d"));	
		}

		//Top amount of subjects rowchart
		function drawSubjectAmount () {
            var dim = ndx.dimension(function(d){ return d.entityName; });
			var group = dim.group().reduceSum(function(d) { return d.type.length; });
			var filteredGroup = (function(source_group) {
				return {
					all: function() {
						return source_group.top(10).filter(function(d) {
							return (d.key != "" && d.key != "Unknown" && d.key != "Not mentioned" && d.value != 0);
						});
					}
				};
			})(group);
			var hosttypecolor = {			
				"Other":"#bbbbbb"
			};
			var graph = dc.rowChart(".top10subjects")   
				.margins({top: 0, right: 3, bottom: 20, left: 3})
				.height(370)
				.gap(3)
				.x(d3.scale.ordinal())
				.elasticX(true)
				.colorCalculator(function(d, i) {
					return "#039aab";
				})
				.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(filteredGroup);

			graph.xAxis().ticks(5).tickFormat(d3.format("d"));	
		}
		

		//Register year barchart
        function drawRegisterYear() {

            var min = 2006;
            var max = 2018;
			
			var dim = ndx.dimension(function(d){
				return d.registerYear;
				//console.log(d.registerYear);
			});
			var group = dim.group().reduceSum(function(d) { return 1; });

			var hosttypecolor = {			
				"Other":"#bbbbbb"
			};

			var graph = dc.barChart(".registeryear")  
				.margins({top: 0, right: 30, bottom: 60, left: 30})
				.height(440)
				.outerPadding(0)
				.gap(3)
				.colorCalculator(function(d, i) {
					return "#039aab";
				})
				/*
				.on("postRender", function( chart ){
					adjustBarChartLabels(chart);
				})
				*/ 
				.x(d3.scale.ordinal())
				.xUnits(dc.units.ordinal)
				.brushOn(false)
				.elasticY(true)
				.yAxisLabel("")
				.dimension(dim)
				.group(group);


			function adjustBarChartLabels(chart) {
				chart.svg().selectAll('.axis.x text')
					.style("text-anchor", "end" )
					.attr("transform", function(d) { return "rotate(-45, -4, 9) "; });
			}
		}

		//euRegisterParliament
		function drawEuRegisterParliament() {

			var dim = ndx.dimension(function(d){
				return d.registerAndParliament;
				
			}, true);
			var group   = dim.group().reduceSum(function(d) { return 1; });

			var hosttypecolor = {			
				"Other":"#bbbbbb"
			};
			var graph = dc.barChart(".euRegisterParliament")   
				.margins({top: 0, right: 3, bottom: 80, left: 20})
				.height(425)
				.x(d3.scale.ordinal().domain(["","Rejestr Unii Europejskiej", "Sejmie i Senacie", "Rządzie", ""]))
				.xUnits(dc.units.ordinal)
				.gap(30)
				.brushOn(false)
				.xAxisLabel('')
				.yAxisLabel('')
				.dimension(dim)
				.elasticX(true)
				.elasticY(true)
				.centerBar(false)
				.barPadding(0.4)
				/*
				.on("postRender", function( chart ){
						adjustBarChartLabels(chart);
				}) 
				*/
				.colorCalculator(function(d, i) {
					if(d.key == "Rządzie"){
						return "#039aab";
					} else if(d.key == "Rejestr Unii Europejskiej"){
						return "#036a7b";
					} else if(d.key == "Sejmie i Senacie"){
						return "#33cadb";
					}
				})
				.group(group);

			function adjustBarChartLabels(chart) {
				chart.svg().selectAll('.axis.x text')
					.style("text-anchor", "end" )
					.attr("transform", function(d) { return "rotate(-45, -4, 9) "; });
			}
		}
		

		function setword(wd) {
			$("#search-input").val(wd);
			var s = wd.toLowerCase();
			nameEvent.filter(function (d) { 
				return d.indexOf (s) !== -1;} );
			$(".resetall").attr("disabled",false);
			throttle();
			var throttleTimer;
			function throttle() {
				window.clearTimeout(throttleTimer);
				throttleTimer = window.setTimeout(function() {
						dc.redrawAll();
				}, 250);
			}
		}

		//WordCloud Chart
		function drawCloud() {
			 var dim = ndx.dimension(function(d) {
			  return d.subject || "";
			 })
			 var group   = dim.group().reduceSum(function(d) { return 1; });
			 var graph =  dc.wordCloud(".wordcloud")
			  .rotate(function() { return ~~(Math.random() * 2) * 90; })
			  .size([550,380])
			  .dimension(dim)
			  .maxWords(50)
			  .padding(5)
			  .ordinalColors(['#73daeb', '#33cadb', '#039aab', '#037a8b', '#035a6b'])
			  .group(group)
			  .scale(d3.scale.linear().domain([10,100]).range([6, 30]))
			  .textAccessor(function(d) {return d.subject;})
			  .onClick(function(d){setword(d.key);})
			  .stopWords (/^(z|rp|2|do|nr|i|na|dot|7%owej|GUO|od|przez|zmanie|ustawy|w|oraz|dot)$/);
		}

		//Ministries
		function drawMinistries() {
			var dim = ndx.dimension(function(d){ return d.ministriesArray; }, true);
            var group = dim.group();
			var hosttypecolor = {			
				"Other":"#43daeb"
			};
			var graph = dc.rowChart(".ministriesRegistrations")   
				.margins({top: 0, right: 3, bottom: 20, left: 3})
				.height(400)
				.gap(3)
				.x(d3.scale.ordinal())
				.elasticX(true)
				.colorCalculator(function(d, i) {
					if(d.key == 'Brak informacji o kontaktach'){
						return "#63cadb";
					}
					return "#039aab";
				})
				.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(group);

			graph.xAxis().ticks(5).tickFormat(d3.format("d"));	
		}

		//Datatables table
		function drawTable () {
			var count=0;
			datatable = $(".table").dataTable({
				"columnDefs": [ 
				  {
				  "searchable": false,
				  "orderable": true,
				  "targets": 0,
				  "defaultContent":"N/A",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.id; 
					},
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 1,
				  "defaultContent":"N/A",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.registerDateMinistry; 
					},
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 2,
				  "defaultContent":"N/A",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.entityName; 
					},
				  },{
				  "defaultContent":"N/A",
				  "searchable": false,
				  "orderable": true,
				  "targets": 3,
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.Euregister;
					}
				  },{
				  "defaultContent":"N/A",
				  "searchable": false,
				  "orderable": true,
				  "targets": 4,
				  "data": function(d) {
					 if (!d) return "";
					 return d.category;
					},
				  },
				   {
				  "defaultContent":"N/A",
				  "searchable": false,
				  "orderable": true,
				  "targets": 5,
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.ministries; 
					}
				  },
                  {
				  "defaultContent":"N/A",
				  "searchable": false,
				  "orderable": true,
				  "targets": 6,
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.parliamentActivity; 
					}
				  }
				],
				"iDisplayLength" : 100,
				"bPaginate": true,
				"bLengthChange": false,
				"bFilter": false,
				"order": [[ 0, "asc" ],[2,"asc"]],
				"bSort": true,
				"bInfo": false,
				"bAutoWidth": false,
				"bDeferRender": true,
				"aaData": nameEvent.top(Infinity),
				"bDestroy": true,
			});
		
			function countmeetings(who){
				var countedmeetings = _.filter(events, function(event, index) {
				  return event.nombrePasivoFull == who || event.nombreActivoFull == who;
				});
				return countedmeetings.length;
			}
				
			function format (d) {				
				if (!d) return "no data";

                var entityData = _.filter(events,function (m) { return m.entityName == d.entityName  });

				var s  = "<div class='l_data_container row'>";
				
				s += "<div class='col-md-12 l_data_container_host'>";
				s += "<div class='l_name' style='text-align:center;margin-bottom:30px;'><label><strong>"+d.entityName+"</strong></label></div>";
				s += "<div class='data_container_title' style='text-align:center;'></div>";
				
				s += "<table><thead><tr><th>Przedstawiciele lob-bysty zawodowego w Sejmie i Senacie</th><th>Klienci</th><th>Data uz-yskania przepustki</th><th>Data wygaśnięcia przepustki</th><th>Przedmiot lobbingu</th></tr></thead><tbody>";
                 _.each (entityData, function (r) {
					s += "<tr><td>"+r.representatives+"</td><td>"+r.clients+"</td><td>"+r.registerDate+"</td><td>"+r.expirationDate+"</td><td>"+r.subject+"</td></tr>";
                });
                s += "</tbody></table>";
				
				
				s += "</div>";
				s += "</div>";
				return s;
				
			}	
			//Datatables click function
			datatable.on('click', 'button', function () {
				var tr = $(this).closest('tr');
				var type=$(this).data("type");
				var pre=$(this).parent().parent().next("pre");
				var row = datatable.DataTable().row( tr.prev()[0] );
				var d=row.data();
			 
				if (type == "event") {
					var sevents =[];
					_.each(events,function (e){
					if (e.guestid == d.id)
					  sevents.push(e);
					});
					pre.html(JSON.stringify(sevents,null,2));
					return;
				}

				var r = (tr.data("representative"));
				if (!r) {
				  url="http://api.lobbyfacts.eu/api/1/representative/"+d.id+"?callback=?";
				  $.getJSON( url, function( data ) {
					tr.data("representative",data);
					display (data);
				  });
				  return;
				}
				display(r,type);

				function display (data) {
				  switch (type) {
					case "financial_data":
					 pre.html(JSON.stringify(data["financial_data"],null,2));
					  break;
					case "accreditation":
					 pre.html(JSON.stringify(data["accreditations"],null,2));
					  break;
					default:
					  pre.html(JSON.stringify(data,null,2));
				  }
				}
				
			});
		
			datatable.DataTable().on('click', 'tr[role="row"]', function () {
				var tr = $(this);
				var row = datatable.DataTable().row( tr );
				if ( row.child.isShown() ) {
					// This row is already open - close it
					row.child.hide();
					tr.removeClass('shown');
				}
				else {
					// Open this row
					row.child( format(row.data()) ).show();
					tr.addClass('shown');
					var height1 = $('.l_data_container_host').height();
					var height2 = $('.l_data_container_guest').height();
					if(height1 > height2){
						$('.l_data_container_guest').height(height1);
					} else {
						$('.l_data_container_host').height(height2);
					}
				}
			});
			
			datatable.DataTable().on( 'order.dt search.dt page.dt draw.dt', function () {
				var thispage = $('.paginate_button.current').html();			
				var rowi = 0;
				/*
			  datatable.DataTable().column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
				if(rowi >= 100){
					rowi = 0;
				}
				rowi ++;
				if(thispage > 1){
					cell.innerHTML = (rowi) + (100*(thispage-1));
				} else {
					cell.innerHTML = (rowi);
				}
			  });
			  */
			});
		}
		//End datatable table function

	
	   function RefreshTable() {
			dc.events.trigger(function () {
				var alldata = evt.top(Infinity);
				if(datatable){
					datatable.fnClearTable();
					datatable.fnAddData(alldata);
					datatable.fnDraw();
				}
			});
		}
		

		//Draw graphs
		drawTable();
		drawHostType();
		drawRegisterYear();
		drawEuRegisterParliament();
		drawMinistries();
		drawCloud();
		drawSubjectAmount();

		dc.renderAll();  
	}
	//End grid function

	$(function() {
		
		//Load datasets
		d3.csv("./data/tab2.csv", function (rows) {
			
			events = rows;
			//renderLoaded();
			var dateFormat = d3.time.format("%d/%m/%Y");
			var now = Date.now();
			var a;


			var subjectTypes = {
				'st1': 'administracja i sprawy wewnêtrzne',
				'st2': 'cyfryzacja i nowoczesne technologie',
				'st3': 'kontrola pañstwa i prawa obywateli',
				'st4': 'finanse i podatki',
				'st5': 'energetyka',
				'st6': 'gospodarka i handel',
				'st7': 'obrona narodowa',
				'st8': 'ochrona œrodowiska',
				'st9': 'polityka spo³eczna i rynek pracy',
				'st10': 'ochrona zdrowia',
				'st11': 'rolnictwo',
				'st12': 'transport i drogi',
				'st13': 'infrastruktura i budownictwo',
				'st14': 'samorz¹d terytorialny',
				'st15': 'sprawiedliwoœæ i s¹downictwo',
				'st16': 'sprawy zagraniczne',
				'st17': 'sprawy europejskie',
				'st18': 'sport i turystyka',
				'st19': 'nauka i szkolnictwo wy¿sze',
				'st20': 'edukacja',
				'st21': 'kultura'
			}
			
			//Loop through dataset and fix/adjust data, also generate the main dataset with 1 entry per entity
			var thisid = 0;
			var thisid2 = 0;

			var events_singleEntry = [];

			_.each (events, function (d) {

                //Get year of registration date (Data uzyskania przepustki)
                d.registerYear = '';
                if(d.registerDateMinistry && d.registerDateMinistry.split('-').length > 1){
                    d.registerYear = d.registerDateMinistry.split('-')[0];
                }
				
                d.type = [];
                //Turning the separate category columns into usable array
				for (var i = 1; i < 22; i++) { 
					if(d['st'+i] == 1){
						d.type.push(subjectTypes['st'+i]);
					};
				}
				console.log(d.type.length);
				
				d.num = thisid;
				thisid ++;

				//Ministries array
				d.ministriesArray = d.ministries.split(", ");

				//Euregister
				//parliamentActivity
				d.registerAndParliament = [];
				if(d.Euregister == "Tak"){
					d.registerAndParliament.push("Rejestr Unii Europejskiej");
				}
				if(d.parliamentActivity == "Tak"){
					d.registerAndParliament.push("Sejmie i Senacie");
				}
				if(d.registerYear.length > 1){
					d.registerAndParliament.push("Rządzie");
				}


				//Check if entity entry already exists
				var entityEntry = _.find(events_singleEntry,function (m) { return m.entityName == d.entityName  });
				if(entityEntry){
					/*
					if(d.registerYear !== ''){
						if(entityEntry.registerYear.indexOf(d.registerYear) == -1){
							entityEntry.registerYear.push(d.registerYear);
						}
					}
					*/
					entityEntry.subject.push(d.subject);
					entityEntry.type.concat(d.type);
				} else {
					//id	entityName	Euregister	category	ministries	parliamentActivity	representatives	clients	registerDate	expirationDate	subject
					var newEntity = {
						'id':d.id,
						'entityName': d.entityName,
						'Euregister': d.Euregister,
						'category': d.category,
						'ministries': d.ministries,
						'parliamentActivity': d.parliamentActivity,
						'registerYear': d.registerYear,
						'registerDateMinistry': d.registerDateMinistry,
						'subject': [d.subject],
						'type': d.type,
						'num': thisid2,
						'registerAndParliament': d.registerAndParliament,
						'ministriesArray': d.ministriesArray
					};
					/*
					if(d.registerYear == ''){
						newEntity.registerYear = [];
					}
					*/
					thisid2 ++;
					events_singleEntry.push(newEntity);
				}
			});
			//End loop through dataset
			//Call grid function to create and display charts
			//grid("#ec",events);
			$('#loader-container').hide();
			grid('#ec',events_singleEntry);
		}); 

		//Search field functionality
		$("#search-input").keyup (function () {
			var s = $(this ).val().toLowerCase();
			nameEvent.filter(function (d) { 
				return d.indexOf (s) !== -1;} );
			$(".resetall").attr("disabled",false);
			throttle();
			var throttleTimer;
			function throttle() {
				window.clearTimeout(throttleTimer);
				throttleTimer = window.setTimeout(function() {
						dc.redrawAll();
				}, 250);
			}
		});
		
		//Change selected term
		$( "#termselect" ).change(function () {
			var s = "termoffice:"+$( "select option:selected" ).text()+" ";
			nameEvent.filter(function (d) { 
				return d.indexOf (s) !== -1;} );
			$(".resetall").attr("disabled",false);
			throttle();
			var throttleTimer;
			function throttle() {
				window.clearTimeout(throttleTimer);
				throttleTimer = window.setTimeout(function() {
						dc.redrawAll();
				}, 250);
			}
		  });
		 
		//Reset button
		$(".resetall").click(function() {
			nameEvent.filter(null);
			dc.filterAll();
			dc.renderAll();
			$("#search-input").val("");
			$(".resetall").attr("disabled",true);
			$( "#termselect" ).val("");
		}); 

		//On window resize redraw for responsive charts
		$(window).on('resize', function(){
			dc.renderAll();
		});

	});      

</script>
</body>
</html>